---
title: "blastocyst_validation"
author: "Moi T. Nicholas"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{blastocyst_validation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  eval = FALSE
)
```

This vignette will take you through running PPR. \
The data used here is an Intregrated dataset of [blastocyst data](http://). \
\
\

# Data Pre-procesing
#### Load neccecary packages
```{r}
library(Seurat)
library(ggplot2)
library(SingleCellExperiment)
library(slingshot)
library(RColorBrewer)
library(GeneSwitches)
library(devtools)
devtools::load_all()
```

## SEURAT
### Here we use this Reprogramming dataset as the reference 
```{r}
reference_seu <- readRDS("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/additional_blastocyst/full_atlas.rds")
kd07_seu <- readRDS("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/additional_blastocyst/Atlas_Karvas_D07.rds")
kd14_seu <- readRDS("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/additional_blastocyst/Atlas_Karvas_D14.rds")
kd21_seu <- readRDS("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/additional_blastocyst/Atlas_Karvas_D21.rds")
validation_seu <- readRDS("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/additional_blastocyst/Atlas_Validation_Blastocyst.rds")

```

#### View the reference UMAP
```{r}
# p1 <- DimPlot(object = seu, 
#              reduction = "umap",
#              group.by = "orig.ident",
#              label = TRUE) +
#      ggtitle("Reference")
# ggsave(filename = "/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/plots/validation/reference_dimplot_orig_ident.png", plot = p1)

# Plot and save the second DimPlot
# p2 <- DimPlot(object = seu,
#              reduction = "umap",
#              group.by = "seurat_clusters",
#              label = TRUE) +
#      ggtitle("Reference")
#ggsave(filename = "/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/plots/dimplot_seurat_clusters.png", plot = p2)
```

### QC
```{r}
# Visualize QC metrics as a violin plot
VlnPlot(seu, features = c("nFeature_RNA", "nCount_RNA", "pctMT"), ncol = 3)
```

### QC
```{r}
#consider using double finder (has it aleady been run?)
seu <- subset(seu, subset = pctMT < 11 & nCount_RNA < 1.8e+07)
# Visualize QC metrics as a violin plot
#VlnPlot(seu, features = c("nFeature_RNA", "nCount_RNA", "pctMT"), ncol = 3)




```

### Extract the samples.
```{r}
reference_seu <- subset(x = reference_seu, subset = lineage %in% "ICM.EPI")

kd07_seu <- subset(x = kd07_seu, subset = orig.ident %in% "D7")
kd14_seu <- subset(x = kd14_seu, subset = orig.ident %in% "D14")
kd21_seu <- subset(x = kd21_seu, subset = orig.ident %in% "D21")
LW120_seu <- subset(x = validation_seu, subset = orig.ident %in% "LW120")
LW122_seu <- subset(x = validation_seu, subset = orig.ident %in% "LW122")

# make a list of the seurat objects
#samples_seu <- list(kd07_seu, kd14_seu, kd21_seu, LW120_seu, LW122_seu, reference_seu)
samples_seu <- vector(mode = "list", length = 6)
names(samples_seu) <- c("kd07", "kd14", "kd21", "LW120", "LW122", "reference")
sample_names <- names(samples_seu)

```


### Label transfer & Re-integration
####### *When doing this analysis with your own data you would more than likely need to label transfer with your referenece datatset.*
####### *As we are using subsets of our reference data as "samples" this wont be necessary.*

## SingeCellExperiment
### Convert objects to SingleCellExperiment objects
```{r}
# samples_sce <- list()
# for (sample_name in names(samples_seu)) {
#   sample_seu <- samples_seu[[sample_name]]
#   sample_sce <- SingleCellExperiment(assays = list(expdata = sample_seu@assays$RNA$counts))
#   samples_sce[[sample_name]] <- sample_sce
# }


## remove two cells from the reference data
dim(samples_sce$reference)
# Identify the cells you want to remove
cells_to_remove <- c("Petro16_E6.12.1269", "Petro16_E7.9.562")

# Check if these cells exist in the colnames of the SingleCellExperiment object
existing_cells <- colnames(samples_sce$reference)
cells_to_remove <- cells_to_remove[cells_to_remove %in% existing_cells]

# Subset the SingleCellExperiment object to exclude the specified cells
samples_sce$reference <- samples_sce$reference[, !(colnames(samples_sce$reference) %in% cells_to_remove)]

# Check the dimensions to ensure the cells have been removed
dim(samples_sce$reference)

```


## Slingshot

### Run slingshot on the reference data to produce a reprogramming trajectory.
```{r}
## Slingshot
### Run slingshot on the reference data to produce a reprogramming trajectory.
# print("Running Slingshot...")
# colData(samples_sce$reference) <- DataFrame(samples_seu$reference@meta.data)
# reducedDims(samples_sce$reference)$UMAP <- samples_seu$reference@reductions$umap@cell.embeddings

# samples_sce$reference <- slingshot(samples_sce$reference,
#                 # clusterLabels = "seurat_clusters",
#                 # start.clus = "23",
#                 # end.clus = "20",
#                  reducedDim = "UMAP")
# # #Rename the Pseudotime column to work with GeneSwitches
# colData(samples_sce$reference)$Pseudotime <- samples_sce$reference$slingPseudotime_1
```

### Plot the slingshot trajectory.
```{r}
# Generate colors
colors <- colorRampPalette(brewer.pal(11, 'Spectral')[-6])(100)
plotcol <- colors[cut(samples_sce$reference$slingPseudotime_1, breaks = 100)]

Open a PDF device to save the plot
# pdf("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/plots/slingshot.pdf")

Plot the data
plot(reducedDims(samples_sce$reference)$UMAP, col = plotcol, pch = 16, asp = 1)
lines(SlingshotDataSet(samples_sce$reference), lwd = 2, col = 'black')

colors <- colorRampPalette(brewer.pal(11, 'Spectral')[-6])(100)
plotcol <- colors[cut(reference_sce$slingPseudotime_1, breaks = 100)]
plot(reducedDims(reference_sce)$UMAP, col = plotcol, pch = 16, asp = 1)
lines(SlingshotDataSet(reference_sce), lwd = 2, col = 'black')

# Close the PDF device
dev.off()
```


## GeneSwitches
###  Choose a Binerization cutoff
###### **this would be good to automate, 
###### or learn how to use the other method of binarizing
```{r}
# hist(as.matrix(assays(sce)$expdata),
#            breaks = 1e6)
#  hist(as.matrix(seu@assays$RNA$counts), breaks = 1e6)
#  
#  hist(as.matrix(assays(sce)$expdata),
#            breaks = 1e6,
#            xlim = c(0, 50))
#  
#  hist(as.matrix(seu@assays$RNA$counts), breaks = 1e6, xlim =c(0, 50))
#  
#  trimmed_expdata <- assays(sce)$expdata[assays(sce)$expdata < 10]
#  hist(as.matrix(trimmed_expdata))
#  abline(v=1, col = "blue")
#  
#  trimmed_expdata <- seu@assays$RNA$counts[seu@assays$RNA$counts < 10]
#  hist(as.matrix(trimmed_expdata))
#  abline(v=1, col = "blue")
#cutoff =1
 
```

### Binarize
```{r}
## GeneSwitches
### Binarize
# print("Binarizing data...")
# start_time <- Sys.time() # Record start time
# print(paste("Binarization started at:", start_time))
# #samples_sce$reference   <- binarize_exp(samples_sce$reference, fix_cutoff = TRUE, binarize_cutoff = 1, ncores = 64)

# samples_sce_binarized <- list()
# for (sample_name in names(samples_sce)){
#   sample_sce <- samples_sce[[sample_name]]
#   sample_sce_binarized <- binarize_exp(sample_sce, fix_cutoff = TRUE, binarize_cutoff = 1, ncores = 40)
#   samples_sce_binarized[[sample_name]] <- sample_sce_binarized
# }

# for (sample_name in names(samples_sce)){
#   print(sample_name)
#   print(dim(samples_sce[[sample_name]]))
# }
# end_time <- Sys.time() # Record end time
# print("Data binarized successfully.")
```

### CHECKPOINT
##### **with how long binerizing takes you may want to choose to save objects for future use.
```{r}
# read the sample objects

samples_binarized <- list()
for (sample_name in sample_names){
  samples_binarized[[sample_name]] <- readRDS(paste0("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/additional_blastocyst/binarized_", sample_name, "_sce.rds"))
}
#do better
samples_binarized <- samples_binarized[-6] 
```

### fit logistic regression and find the switching pseudo-time point for each gene
```{r}
#sce <- find_switch_logistic_fastglm(sce, downsample = FALSE, show_warning = FALSE)
```

#### **This is another time consuming process, may want to choose to save objects for future use.**
```{r}
reference_sce <- readRDS("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/additional_blastocyst/switches_fastglm_blastocyst_validation_reference_sce.rds")
```

### Filter to only include Switching Genes
```{r}
switching_genes <- filter_switchgenes(reference_sce, allgenes = TRUE,r2cutoff = 0.278)
```

##### View all of the switching genes
```{r}
# Open a PDF device to save the plot
#pdf("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/plots/timeline_plot.pdf")

# Plot the timeline using plot_timeline_ggplot
plot_timeline_ggplot(switching_genes, timedata = colData(reference_sce)$Pseudotime, txtsize = 3)

# Close the PDF device
#dev.off()
```


# Using PPR

##### View the selected switching genes
```{r}
ppr_timeline_plot(switching_genes)
```

### Reduce the binary counts matricies of the query data to only include the selection os switching genes.
```{r}
# filter the binary counts matricies to only include the switching genes
reference_reduced <- subset_switching_genes(reference_sce, switching_genes)
#Mole21a_reduced   <- subset_switching_genes(sample_Mole21a_binarized, switching_genes)

# Define a list to store the results
samples_reduced <- list()

# Iterate through each Seurat object in the list
for (sample_name in names(samples_binarized)){
  sample_binarized <- samples_binarized[[sample_name]]
  # susbet each sample to only include the switching genes
  sample_reduced <- subset_switching_genes(sample_binarized, switching_genes)
   # Store the result in the new list
  samples_reduced[[sample_name]] <- sample_reduced
}

```

### Produce an estimate for the position on trajectory of each gene in each cell of a sample.
```{r}
reference_ppr    <- ppr_predict_position(reference_reduced, switching_genes)
#Mole21a_ppr      <- ppr_predict_position(Mole21a_reduced, switching_genes)
# Define a list to store the ppr objects of the samples
samples_ppr <- list()

# Iterate through each Seurat object in the predicting their positons,
# on the reference trajectory, using PathPinpointR
for (sample_name in names(samples_reduced)){
  sample_reduced <- samples_reduced[[sample_name]]
  # predict the position of each gene in each cell of the sample
  sample_ppr <- ppr_predict_position(sample_reduced, switching_genes)
  # Store the result in the new list
  samples_ppr[[sample_name]] <- sample_ppr
}
```

### Accuracy
#### *As our samples are subsets of the reference dataset we can calculate the accuracy of GSS*
```{r}
# Open a PDF device to save the plot
#pdf("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/plots/reference_accuracy.pdf")
#ppr_accuracy_test(Mole21a_ppr, reference_sce, plot = TRUE)
ppr_accuracy_test(reference_ppr, reference_sce, plot = TRUE)
# Close the PDF device
#dev.off()

```

## Plotting

### Plot the predicted position of each sample:
#### *Optional: include the switching point of some genes of interest:*
```{r}

# Open a PDF device to save the plot
#pdf("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/plots/reference_ppr_output.pdf")
ppr_output_plot(reference_ppr, col = "red", overlay=FALSE, label = "Reference")
# Close the PDF device
#dev.off()

for (sample_name in names(samples_ppr)){
  sample_ppr <- samples_ppr[[sample_name]]
  pdf(paste0("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/plots/", sample_name,"_ppr_output.pdf"))
  ppr_output_plot(sample_ppr, col = "red", overlay=FALSE, label = sample_name)
  # Close the PDF device
  dev.off()
}

#> names(samples_ppr)
#[1] "kd07"  "kd14"  "kd21"  "LW120" "LW122"

#pdf("/mainfs/ddnb/PathPinpointR/package/PathPinpointR/data/plots/samples_ppr_output.pdf")
ppr_output_plot(samples_ppr[[1]], col = "red", overlay=FALSE, label = names(samples_ppr)[1])
ppr_output_plot(samples_ppr[[2]], col = "blue", overlay=TRUE, label = names(samples_ppr)[2])
ppr_output_plot(samples_ppr[[3]], col = "purple", overlay=TRUE, label = names(samples_ppr)[3])
ppr_output_plot(samples_ppr[[4]], col = "#000000", overlay=TRUE, label = names(samples_ppr)[4])
ppr_output_plot(samples_ppr[[5]], col = "#4dd80c", overlay=TRUE, label = names(samples_ppr)[5])
# Close the PDF device
#dev.off()

```




#### Plot an indervidual cell.
```{r}
ppr_cell_plot(samples_ppr[[1]], cell_idx = 1)
```

```{r}
ppr_timeline_plot(switching_genes,
genomic_expression_traces = TRUE,
reduced_sce = samples_reduced[[5]],
cell_id = 1)
```

### Precision
##### Estimate the precision of PPR by running accuracy_test at a range of values
```{r}
ppr_precision(sce = reference_sce, r2_cutoff_range = seq(0.1, 0.4, 0.01))
#0.278
```




